<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Cool Maze - Send your document from mobile to computer</title>
  <script src="https://js.pusher.com/3.2/pusher.min.js"></script>
  <script src="static/js/qrcodejs/qrcode.min.js"></script>
  <link rel="SHORTCUT ICON" href="static/img/coolmaze_128.png">
  <link rel="dns-prefetch" href="https://storage.googleapis.com/">
  <style>
  body {
    text-align: center;
    /*background-color: #64d8ff;*/
  }
  input[readonly]
  {
    background-color: white;
  }
  #qr-zone {
    /*clear: both;*/
  }
  #qrcode {
    text-align: center;
  }
  #qrcode img {
    /*float: left;*/
    margin: auto;
    /*margin-top: 20px;*/
    border-radius: 12px;
    cursor: zoom-in;
  }
  #overprint-logo {
    position: absolute;
  }
  #progress-zone {
    min-height: 34px;
    padding: 8px;
  }
  #txt-msg-zone {
    margin-left: 10%;
    width: 80%;
    margin-top: 20px;
    margin-bottom: 20px;
    padding: 20px;
    background-color: white;
    text-align: center;
    border-radius: 15px;
  }
  #txt-msg-close {
    float: right;
    margin-top: -0.5em;
    font-weight: bolder;
    font-size: 2em;
    cursor: pointer;
  }
  #inbox {
    margin-top: 12px;
    border: none;
    font-size: 3em;
    background-color: white;
    max-width: 100%;
  }
  #help {
    float: left;
    margin-left: 10px;
    margin-bottom: 8px;
    background-color: white;
    border: 1px solid #AAA;
    padding: 8px;
    text-align: left;
    border-radius: 15px;
  }
  #question-mark {
    font-weight: bolder;
    font-size: 2em;
    cursor: pointer;
    padding: 10px 8px 8px 10px;
    margin: -2px 0 0 -2px;
  }
  #help-contents {
    width: 100%;
  }
  #help-contents img.right {
    float: right;
    /*text-align: center;*/
    margin: 12px;
  }
  #help-close {
    float: right;
    margin-top: -2em;
    font-weight: bolder;
    font-size: 2em;
    cursor: pointer;
  }
  .link-to-dual {
    display: inline-block;
    margin-top: 50px;
    border-top: dotted #AAA;
  }
  .mini-picto {
    width: 1em; 
    vertical-align:middle; 
    padding-bottom:2px;
  }
  .rounded {
    border: 1px solid #AAA;
    border-radius: 5px;
    padding-left: 2px;
    padding-right: 2px;
    white-space: nowrap;
  }
  .ib {
    display: inline-block;
  }
  .thumb {
     border: 4px solid transparent;
     margin: 6px;
  }
  .thumb.link {
    border: 4px solid yellow;
    border-radius: 2px;
    cursor: pointer;
  }
  </style>
</head>








<body>
  <div id="help">
    <div><span id="question-mark">?</span></div>
    <div id="help-contents" style="display: none;">
      <div id="help-close">X</div>
      <img src="static/img/schema.png" width="296" height="400" class="right" />
      <p>You can share a document from your mobile device to a desktop computer or video projector</p>
      <p>
        <ol>
          <li>Download the <strong><a href="https://play.google.com/apps/testing/net.coolmaze.coolmaze">Cool Maze app</a></strong> on your Android mobile</li>
          <li>Open <strong>coolmaze.io</strong> in your desktop browser</li>
          <li>On mobile resource (photo, video, URL, PDF), select <span class="rounded"><strong><i>Share via</i></strong></span> > <span class="rounded"><img src="static/img/coolmaze_128.png" class="mini-picto" /> <strong>Cool Maze</strong></span></li>
          <li>Scan the QR-code</li>
        </ol>
      </p>
      <p>That's it. No login, no passwords, no ads.</p>
      <p>The two devices (source and target) must have internet connection.</p>
      <p><strong>Your data remains private</strong>. It is not publicly available and not disclosed to third parties. See the <a href="terms.html">Privacy terms</a>.</p>
      <p>Resource is discarded a few minutes after upload, so you may want to explicitly save it on your computer.</p>

      <div class="link-to-dual">
      But I want to send from desktop to mobile instead! Use <a href="/hot">Hot Maze</a>.
      </div>
    </div>
  </div>

  <div id="qr-zone">
    <div id="qrcode"> 
    </div>
  </div>

  <div id="progress-zone">
    <progress value="0.0" id="multi-progress" style="display: none;"></progress>
  </div>

  <div id="thumbs">
  </div>

  <div id="txt-msg-zone" style="display: none;">
    <div id="txt-msg-close">X</div>
    <h3>Received text message</h3>
    <textarea id="inbox" readonly="readonly" rows="12" cols="32"></textarea>
  </div>
  <div id="errors">
  </div>

  <link rel="prefetch" href="static/img/red_arrow.png">
  <link rel="prefetch" href="static/img/red_spinner.gif">
  <link rel="prefetch" href="static/img/check_128.png">








  <script type="text/javascript">
    // Those are a few hundred lines of highly questionable JS.
    // They should be rewritten entirely, but preferably keeping vanilla
    // JS, avoiding jQuery (25KB compressed) or other framework.

    var backend = "https://cool-maze.appspot.com";
    // var backend = "https://dev-dot-cool-maze.appspot.com";
    // var backend = "http://localhost:8080";
    var coolMazePusherAppKey = 'e36002cfca53e4619c15';

    // Since #108, qrKey==chanID and it is random generated in JS.
    var qrKey = "";
    var chanID = "";
    var pusher;
    var channel;

    var errorZone = document.getElementById("errors");
    var qrzone = document.getElementById("qr-zone");
    var qrcode = document.getElementById("qrcode");
    var questionMark = document.getElementById("question-mark");
    var help = document.getElementById("help");
    var helpContents = document.getElementById("help-contents");
    var helpClose = document.getElementById("help-close");
    var msg = document.getElementById("txt-msg-zone");
    var txtMsgClose = document.getElementById("txt-msg-close");
    var inbox = document.getElementById("inbox");
    var thumbs = document.getElementById("thumbs");
    var multiProgress = document.getElementById("multi-progress");

    function showError(errmsg) {
      console.log("Error: " + errmsg)
      clearQR();
      freezeResize();
      errorZone.innerHTML = errmsg;
      return false;
    }

    var qrHundredth = 40;
    // Bookmarks or WebExtension can point directly to the big
    // QR-code size, with ?big=1
    if( window.location.search.indexOf("big=1")  !== -1 )
      qrHundredth = 96;

    function render(colorDark, clickCallback){
      // qrHundredth == 95 is a "big QR-code" (almost fullscreen)
      // qrHundredth == 50 is a "medium-size QR-code"

      // -50 is for the small [?] box on the left
      var w = Math.max(document.documentElement.clientWidth -50, (window.innerWidth || 0) -50) * qrHundredth / 100;
      var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) * qrHundredth / 100;
      var c = 400;
      if ( w>0 )
        c = w;
      if ( h>0 && h<c )
        c = h;

      var logo = document.getElementById("overprint-logo");
      if ( logo )
        logo.style.display = "none";
      clearQR();
      new QRCode("qrcode", {
        text: qrKey,
        width: c,
        height: c,
        colorDark : colorDark,
        colorLight : "white",
        correctLevel : QRCode.CorrectLevel.M
      });

      var cc = c/4;
      logo = document.getElementById("overprint-logo"); // has changed
      logo.style.width = cc + "px";
      logo.style.height = cc + "px";
      logo.style.top = ((1.5)*cc) + "px";
      logo.style.marginLeft = (-cc/2) + "px";
      //logo.style.display = "inline";
      window.setTimeout(function(){ logo.style.display = "inline"; }, 40);

      // The QR-code contents is clickable to embiggen, not the whole qr-zone
      if (clickCallback)
        for(var i=0; i < qrcode.childNodes.length; i++)
          qrcode.childNodes[i].onclick = clickCallback;
    }

    // Go fullscreen -> bigger QR
    var resizeTimeOut = null;
    window.onresize = function(){
        if (resizeTimeOut != null)
            clearTimeout(resizeTimeOut);
        resizeTimeOut = setTimeout(function(){
            render("black", embiggen);
        }, 300);
    };
    function freezeResize(){
      // after scan, or on fatal error, we don't need/want to
      // redisplay a fresh black QR-code again.
      window.onresize = function(){ return false; }
    }

    function clearQR() {
      var node = qrcode;
      while (node.firstChild) {
          node.removeChild(node.firstChild);
      }
      node.innerHTML='<img src="static/img/red_arrow.png" id="overprint-logo" style="display: none;" />';
    }

    function startsWith(str, word) {
     return str.lastIndexOf(word, 0) === 0;
    }

    function show(id) {
      // Show either "qr-zone", or "help-contents", or "txt-msg-zone".

      var dispQr = "none";
      var dispHelpContents = "none";
      var dispMsg = "none";
      var bgcolor = "#64d8ff";
      switch(id) {
        case "qr-zone":
          dispQr = "block";
          bgcolor = "white"; // or keep it always blue...?
          break;
        case "help-contents":
          dispHelpContents = "block";
          break;
        case "txt-msg-zone":
          dispMsg = "block";
          break;
      }
      qrzone.style.display = dispQr;
      helpContents.style.display = dispHelpContents;
      msg.style.display = dispMsg;
      document.body.style.backgroundColor = bgcolor;
    }

    function genRandomQrKey() {
      var chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
      var M = chars.length; // 62
      var L = 11;
      var s = "";

      var crypto = window.crypto || window.msCrypto;
      if( crypto ) {
        var buf = new Uint8Array(L);
        crypto.getRandomValues(buf);
        for(var i=0; i<L; i++) {
          // 01234567 would be slightly more frequent, which is OK for our use case
          var j = buf[i] % M;
          s += chars.charAt(j);
        }
      } else {
        console.log( "Capability window.crypto not found :(" );
        for(var i=0; i<L; i++) {
          // This is less crypto-secure, but the best we can do locally.
          var j = Math.floor(Math.random() * M);
          s += chars.charAt(j);
        }
      }

      console.log("Generated qrKey [" + s + "]");
      return s;
    }

    questionMark.onclick = function(event) { 
        if ( helpContents.style.display === "none" )
          show("help-contents"); 
    }
    helpClose.onclick = function(event) { 
        show("qr-zone"); 
    }
    document.onkeydown = function(evt) {
      evt = evt || window.event;
      var isEscape = false;
      if ("key" in evt) {
        isEscape = (evt.key == "Escape" || evt.key == "Esc");
      } else {
        isEscape = (evt.keyCode == 27);
      }
      if (isEscape) {
        show("qr-zone");
      }
    };

    txtMsgClose.onclick = function(event) { 
      show("qr-zone");
    }
    inbox.onclick = function(event) { 
        event.stopPropagation();
    }

    function embiggen(event) { 
        // Change size on each click
        // 40, 68, 96, 40, 60, 96 ...
        qrHundredth += 28;
        if ( qrHundredth>100 )
          qrHundredth = 40;
        render("black", embiggen);
    }

    function spin() {
      // When we receive a Scan Notification event from Pusher,
      // we are excited about a resource payload coming soon.
      // So we wag tail with a spinning wheel.
      render("#CCC", null);
      var logo = document.getElementById("overprint-logo");
      if ( logo )
        logo.src = "static/img/red_spinner.gif";
    }

    inbox.value = "";

    function attachPusherBindings(){
      pusher.connection.bind( 'error', function( err ) {
        if( err.data.code === 4004 ) {
          showError("We're very sorry, but the Cool Maze service currently runs at maximal capacity. We cannot provide a fresh QR-code right now.");
        } else {
          console.log(err);
        }
      });
    }

    function attachPusherChannelBindings(){
      var eventNotifScan = 'maze-scan';
      channel.bind(eventNotifScan, function(data) {
        if(data.multiIndex) {
          console.log("maze-scan Multiple " + data.multiIndex + " / " + data.multiCount);
          multiProgress.style.display = "inline";
          // Scan notifs count as 20% of total
          multiProgress.value += (0.2 / data.multiCount);
        } else
          console.log("Received scan notification. Payload coming soon.");
        var thumbImg = getThumbImg(data.multiIndex);
        var thumbDataUri = data.message;
        if (thumbDataUri) {
          thumbImg.src = thumbDataUri;
          thumbImg.classList.remove("empty");
        }else{
          newThumb.classList.add("no-preview");
        }

        spin();
        freezeResize();
      });

      var eventCast = 'maze-cast';
      var multipleReceived = 0;
      channel.bind(eventCast, function(data) {
        if(data.multiIndex)
          console.log("maze-cast Multiple " + data.multiIndex + " / " + data.multiCount);

        var msg = data.message;
        if(startsWith(msg,'http') || startsWith(msg,'www.')) {
           var url = msg;
           console.log("Received URL: " + url);

           if(data.multiIndex) {
             // Multiple resource
             window.open(url, "_blank");
             var thumbImg = getThumbImg(data.multiIndex);
             thumbImg.classList.add("link");
             thumbImg.onclick = function() {
               window.open(url, "_blank");
             }
             thumbLinkTimeout(thumbImg);
             if(thumbImg.classList.contains("no-preview"))
               thumbImg.src = "static/img/thumbnail-file.png";

              // Cast notifs (data is ready!) count as 80% of total
              multiProgress.value += (0.8 / data.multiCount);

             multipleReceived ++;
             if( multipleReceived == data.multiCount ){
                multiProgress.value = 1.0;
                var logo = document.getElementById("overprint-logo");
                if ( logo )
                  logo.src = "static/img/check_128.png";
             }

           } else {
             // Single resource
             inbox.value = "Redirecting to " + url + " ...";
             show("txt-msg-zone");
             window.location = url;
           }
           return;
        }
         //alert(data.message);
         console.log("Received message: " + data.message);
         inbox.value = data.message;
         show("txt-msg-zone");
      });
    }

    function getThumbImg(i) {
      var thumb = document.getElementById("thumbnail-" + i);
      if(thumb)
        return thumb;
      var newThumb = document.createElement("img");
      newThumb.setAttribute("id", "thumbnail-" + i);
      newThumb.classList.add("thumb");
      newThumb.classList.add("empty");
      newThumb.src = "static/img/thumbnail-empty.png";
      // This is not always sorted 0, 1, ... N (for now)
      thumbs.appendChild(newThumb);
      return newThumb;
    }

    function thumbLinkTimeout(thumbImg) {
      // Issue #128
      // GCS token expires. So, it's nicer to remove link too.
      var ms = 9 * 60 * 1000;
      window.setTimeout(function(){
          thumbImg.onclick = function() { return false; };
          thumbImg.classList.remove("link");
      }, ms);
    }

    function checkInternetAndExecute(action){
      // This request is supposed to be fast.
      var tinyRequest = new XMLHttpRequest();
      tinyRequest.onreadystatechange = function() {
          if (tinyRequest.readyState == 4 ) {
            if (tinyRequest.status == 200) {
              // #110: response ensures we have internet connectivity
              action();
            } else {
              showError("No internet...?");
            }
          }
      };
      tinyRequest.open("GET", backend+"/online", true);
      tinyRequest.send( null );
    }

    function wakeUpBackend(){
      // This request can be slow.
      // We don't need to wait for the response.
      var wakeup = new XMLHttpRequest();
      var wuEndpoint = backend + "/wakeup";
      var wuParam = "qrKey=" + qrKey;
      wakeup.open("GET", wuEndpoint + "?" + wuParam, true);
      wakeup.send( null );
    }

    window.addEventListener('offline', function(){
      showError("Lost internet connectivity :(")
    });

    window.setTimeout(function(){ 
      if ( qrzone.style.display == "block" || qrzone.style.display == "" ) {
        showError("Please reload.");
        pusher.disconnect();
      }
    }, 10 * 60 * 1000);

    // Handle slight differences in Embed mode (iframe)
    function handleEmbedMode() {
      var inFrame = false;
      try {
          inFrame = (window.self !== window.top);
      } catch (e) {
          inFrame = true;
      }
      if ( inFrame ) {
        if ( help )
          help.style.display = "none";
      }
    }


    function init() {
      // Spin until we have checked for internet connectivity
      spin();

      //
      // Generate qrKey/chanID -> Listen to Pusher channel -> Check internet -> Render QR-code
      //
      qrKey = genRandomQrKey();
      chanID = qrKey;

      if (typeof Pusher === 'undefined')
        return showError("No internet connectivity :(");

      pusher = new Pusher(coolMazePusherAppKey, {
        encrypted: true
      });
      attachPusherBindings();
      channel = pusher.subscribe(chanID);
      attachPusherChannelBindings();

      checkInternetAndExecute(function(){
        // #110: internet connectivity unlocks the QR-code display.
        render("black", embiggen);
      });

      wakeUpBackend();
      handleEmbedMode();
    }
    init();
  </script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-40444778-5', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>