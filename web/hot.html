<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Hot Maze - Send your document from computer to mobile</title>
  <script src="static/js/qrcodejs/qrcode.min.js"></script>
  <link rel="SHORTCUT ICON" href="static/img/coolmaze_128.png">
  <link rel="dns-prefetch" href="https://storage.googleapis.com/">
  <style>
  body {
    text-align: center;
    /*background-color: #64d8ff;*/
    height: 100%;
    min-height: 500px;
    border: white solid 10px;
  }
  input[readonly]
  {
    background-color: white;
  }
  #drop-invite {
    padding: 30px;
    font-size: 32px;
    font-weight: bold;
    color: #FCC;
  }
  #qr-zone {
    /*clear: both;*/
  }
  #qrcode {
    text-align: center;
  }
  #qrcode img {
    /*float: left;*/
    margin: auto;
    /*margin-top: 20px;*/
    border-radius: 12px;
    cursor: zoom-in;
  }
  #help {
    float: right;
    margin-left: 10px;
    margin-bottom: 8px;
    background-color: white;
    border: 1px solid #AAA;
    padding: 8px;
    text-align: left;
    border-radius: 15px;
  }
  #question-mark {
    font-weight: bolder;
    font-size: 2em;
    cursor: pointer;
    padding: 10px 8px 8px 10px;
    margin: -2px 0 0 -2px;
  }
  #help-contents {
    width: 100%;
  }
  #help-contents img.right {
    float: right;
    /*text-align: center;*/
    margin: 12px;
  }
  #help-close {
    float: right;
    margin-top: -2em;
    font-weight: bolder;
    font-size: 2em;
    cursor: pointer;
  }
  .mini-picto {
    width: 1em; 
    vertical-align:middle; 
    padding-bottom:2px;
  }
  .rounded {
    border: 1px solid #AAA;
    border-radius: 5px;
    padding-left: 2px;
    padding-right: 2px;
    white-space: nowrap;
  }
  #spin-img {
    width: 64px;
    height: 64px;
  }
  .ib {
    display: inline-block;
  }
  </style>
</head>








<body>
  <div id="help">
    <div><span id="question-mark">?</span></div>
    <div id="help-contents" style="display: none;">
      <div id="help-close">X</div>
      <img src="static/img/schema_hot.png" width="296" height="400" class="right" />
      <p>You can share a document from desktop computer to your mobile in seconds</p>
      <p>
        <ol>
          <li>Select a file from your computer on page coolmaze.net/hot</li>
          <li>Scan the QR-code with your mobile</li>
        </ol>
      </p>
      <p>That's it. No login, no passwords, no ads.</p>
      <p>The two devices (source and target) must have internet connection</p>
      <p><strong>Your data remains private</strong>. It is not publicly available and not disclosed to third parties. See the <a href="terms.html">Privacy terms</a>.</p>
    </div>
  </div>

  <div id="form-zone" style="display: block;">
    <form id="resource-upload"> 
      <input type="file" name="resource" id="resource" />
      <div id="drop-invite" style="display: none;">DROP FILE HERE</div>
    </form>
  </div>

  <div id="spin-zone">
    <img id="spin-img" src="static/img/red_spinner.gif"  style="display: none;"/>
  </div>

  <div id="qr-zone">
    <div id="qrcode"> 
    </div>
  </div>

  <div id="errors">
  </div>







  <script type="text/javascript">
    // Those are a few hundred lines of highly questionable JS.
    // They should be rewritten entirely, but preferably keeping vanilla
    // JS, avoiding jQuery (25KB compressed) or other framework.

    var backend = "https://cool-maze.appspot.com";
    // var backend = "https://dev-dot-cool-maze.appspot.com";
    //var backend = "http://localhost:8080";

    var urlPut, urlGet;
    var resourceFile;
    var qrText = "";

    function showError(errmsg) {
      console.log("Error: " + errmsg)
      clearQR();
      freezeResize();
      var errorZone = document.getElementById("errors");
      errorZone.innerHTML = errmsg;
      return false;
    }

    var qrHundredth = 40;

    function render(colorDark, clickCallback){
      // qrHundredth == 95 is a "big QR-code" (almost fullscreen)
      // qrHundredth == 50 is a "medium-size QR-code"

      // -50 is for the small [?] box on the left
      var w = Math.max(document.documentElement.clientWidth -50, (window.innerWidth || 0) -50) * qrHundredth / 100;
      var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) * qrHundredth / 100;
      var c = 400;
      if ( w>0 )
        c = w;
      if ( h>0 && h<c )
        c = h;

      clearQR();
      new QRCode("qrcode", {
        text: qrText,
        width: c,
        height: c,
        colorDark : colorDark,
        colorLight : "white",
        correctLevel : QRCode.CorrectLevel.M
      });
      var qrcode = document.getElementById("qrcode");

      // The QR-code contents is clickable to embiggen, not the whole qr-zone
      if (clickCallback)
        for(var i=0; i < qrcode.childNodes.length; i++)
          qrcode.childNodes[i].onclick = clickCallback;
    }

    // Go fullscreen -> bigger QR
    var resizeTimeOut = null;
    window.onresize = function(){
        if (resizeTimeOut != null)
            clearTimeout(resizeTimeOut);
        resizeTimeOut = setTimeout(function(){
            render("black", embiggen);
        }, 300);
    };
    function freezeResize(){
      // after scan, or on fatal error, we don't need/want to
      // redisplay a fresh black QR-code again.
      window.onresize = function(){ return false; }
    }

    function clearQR() {
      var node = document.getElementById("qrcode");
      while (node.firstChild) {
          node.removeChild(node.firstChild);
      }
    }

    function show(id) {
      var qrzone = document.getElementById("qr-zone");
      var help = document.getElementById("help");
      var helpContents = document.getElementById("help-contents");

      var dispQr = "none";
      var dispHelpContents = "none";
      var bgcolor = "#64d8ff";
      switch(id) {
        case "qr-zone":
          dispQr = "block";
          bgcolor = "white"; // or keep it always blue...?
          break;
        case "help-contents":
          dispHelpContents = "block";
          break;
      }
      qrzone.style.display = dispQr;
      helpContents.style.display = dispHelpContents;
      document.body.style.backgroundColor = bgcolor;
    }

    //document.body.onclick = function() { alert("BG"); show("qr-zone"); }
    document.getElementById("question-mark").onclick = function(event) { 
        if ( document.getElementById("help-contents").style.display === "none" )
          show("help-contents"); 
    }
    document.getElementById("help-close").onclick = function(event) { 
        show("qr-zone"); 
    }
    document.onkeydown = function(evt) {
      evt = evt || window.event;
      var isEscape = false;
      if ("key" in evt) {
        isEscape = (evt.key == "Escape" || evt.key == "Esc");
      } else {
        isEscape = (evt.keyCode == 27);
      }
      if (isEscape) {
        show("qr-zone");
      }
    };

    function embiggen(event) { 
        // Change size on each click
        // 40, 68, 96, 40, 60, 96 ...
        qrHundredth += 28;
        if ( qrHundredth>100 )
          qrHundredth = 40;
        render("black", embiggen);
    }

    function spin() {
      var spinner = document.getElementById("spin-img");
      spinner.style.display = "block";
    }

    function unspin() {
      var spinner = document.getElementById("spin-img");
      spinner.style.display = "none";
    }

    function wakeUpBackend(){
      // This request can be slow.
      // We don't need to wait for the response.
      var wakeup = new XMLHttpRequest();
      var wuEndpoint = backend + "/wakeup";
      wakeup.open("GET", wuEndpoint, true);
      wakeup.send( null );
    }

    function requestGcsUrls(action){
      var r = new XMLHttpRequest();
      r.onreadystatechange = function() {
          if (r.readyState == 4 ) {
            if (r.status == 200) {
              var jsonResponse = JSON.parse(r.responseText);
              urlPut = jsonResponse.urlPut;
              console.log( "urlPut = " + urlPut );
              urlGet = jsonResponse.urlGet;
              console.log( "urlGet = " + urlGet );
              if( jsonResponse.shortUrlGet ){
                urlGet = backend + jsonResponse.shortUrlGet;
                console.log( "urlGet (short) = " + urlGet );
              }
              action();
            } else if (r.status == 412) {
              var jsonResponse = JSON.parse(r.responseText);
              showError(jsonResponse.message);
            } else {
              showError("GCS urls request failed with " + r.status + ": " + r.responseText);
            }
          }
      };
      var endpoint = backend + "/new-gcs-urls";
      var params = "type=" + encodeURIComponent(resourceFile.type)
                   + "&filesize=" + resourceFile.size
                   + "&shorten=1"
                   + "&filename=" + encodeURIComponent(resourceFile.name) ;
      // TODO hash
      r.open("POST", endpoint + "?" + params, true);
      r.send( null );
    }

    window.addEventListener('offline', function(){
      showError("Lost internet connectivity :(")
    });

    // Handle slight differences in Embed mode (iframe)
    function handleEmbedMode() {
      var inFrame = false;
      try {
          inFrame = (window.self !== window.top);
      } catch (e) {
          inFrame = true;
      }
      if ( inFrame ) {
        var help = document.getElementById("help");
        if ( help )
          help.style.display = "none";
      }
    }

    function doUpload(action) {          
          var up = new XMLHttpRequest();
          
          up.onreadystatechange = function(){
            if (up.readyState == 4 ) {
              if (up.status == 200) {
                console.log( up.responseText );
                action();
              }
            }
          };
          
          up.open("PUT", urlPut);
          up.setRequestHeader("Content-type", resourceFile.type);
          up.send(resourceFile);
    }

    function displayGetQrCode() {
      // We generate th QR-code of a custom "medium-size" shortURL,
      // much shorter than the full signed GCS download URL.
      qrText = urlGet;
      render("black", embiggen);

      // GCS URL will be valid for a few minutes only.
      // Discard QR-code after 9mn.
      window.setTimeout(function(){ 
        var qrzone = document.getElementById("qr-zone");
        if ( qrzone.style.display == "block" || qrzone.style.display == "" ) {
          showError("Please reload.");
        }
      }, 9 * 60 * 1000);
    }

    var resourceInput = document.getElementById('resource');
    resourceInput.onchange = function(e) { 
        document.getElementById("form-zone").style.display = "none";
        spin();
        resourceFile = document.getElementById('resource').files[0];

        requestGcsUrls(function(){
          doUpload(function(){
            unspin();
            displayGetQrCode();
          });
        });
    };

    function handleDnd(){

      // See https://css-tricks.com/drag-and-drop-file-uploading/
      var div = document.createElement('div');
      var dndFileSupported = (('draggable' in div) 
        || ('ondragstart' in div && 'ondrop' in div)) 
        && 'FormData' in window && 'FileReader' in window;
      if (!dndFileSupported)
        return;

      var dropInvite = document.getElementById("drop-invite");
      dropInvite.style.display = "block";

      var dropZone = document.body; 

      dropZone.addEventListener('dragover', function(evt){
        //dropZone.style.background = 'red';
        dropZone.style.border = 'red dotted 10px';
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy';
      }, false);

      dropZone.addEventListener('drop', function(evt){
        dropZone.style.background = '#AFA';
        evt.stopPropagation();
        evt.preventDefault();

        var files = evt.dataTransfer.files;
        for (var i = 0, f; f = files[i]; i++)
          console.log(f.name);
        // TODO upload 1st file.
        // TODO upload all files ..?
      }, false);

      dropZone.addEventListener('dragleave', function(evt){
        dropZone.style.border = 'white solid 10px';
      }, false);
    }
    handleDnd();

    wakeUpBackend();
    handleEmbedMode();
  </script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-40444778-5', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>