<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Hot Maze - Send your document from computer to mobile</title>
  <script src="static/js/qrcodejs/qrcode.min.js"></script>
  <link rel="SHORTCUT ICON" href="static/img/hotmaze_128.png">
  <style>
  body {
    text-align: center;
    /*background-color: #64d8ff;*/
    height: 100%;
    min-height: 500px;
    border: rgba(255, 255, 255, 0) solid 10px;
  }
  input[readonly]
  {
    background-color: white;
  }
  #progress-zone {
    clear: both;
    min-height: 20px;
    padding-bottom: 25px;
  }
  #qr-zone {
    clear: both;
  }
  #qrcode {
    text-align: center;
  }
  #qrcode img {
    /*float: left;*/
    margin: auto;
    /*margin-top: 20px;*/
    border-radius: 12px;
    cursor: zoom-in;
  }
  #resource-upload {
    display: inline-block;
    background-image: url('static/img/empty_QR.png');
    background-repeat: no-repeat;
    min-width: 337px;
    min-height: 337px;
    padding-top: 80px;
    padding-left: 90px;
  }
  #resource-upload > form{
    width: 180px;
  }
  #drop-invite {
    /*padding: 30px;*/
    margin-bottom: 20px;
    font-size: 32px;
    font-weight: bold;
    color: #F77;
  }
  #help {
    float: right;
    margin-left: 10px;
    margin-bottom: 8px;
    background-color: white;
    border: 8px solid black;
    padding: 8px;
    text-align: left;
    border-radius: 15px;
  }
  #question-mark {
    font-weight: bolder;
    font-size: 2em;
    cursor: pointer;
    padding: 10px 8px 8px 10px;
    margin: -2px 0 0 -2px;
  }
  #help-contents {
    width: 100%;
  }
  #help-contents img.right {
    float: right;
    /*text-align: center;*/
    margin: 12px;
    max-width: 50%;
  }
  #help-close {
    float: right;
    margin-top: -2em;
    font-weight: bolder;
    font-size: 2em;
    cursor: pointer;
  }
  .link-to-dual {
    display: inline-block;
    margin-top: 50px;
    border-top: dotted #AAA;
  }
  .mini-picto {
    width: 1em; 
    vertical-align:middle; 
    padding-bottom:2px;
  }
  .rounded {
    border: 1px solid #AAA;
    border-radius: 5px;
    padding-left: 2px;
    padding-right: 2px;
    white-space: nowrap;
  }
  #spin-img {
    width: 64px;
    height: 64px;
  }
  .ib {
    display: inline-block;
  }
  </style>
</head>








<body>
  <div id="help">
    <div><span id="question-mark">?</span></div>
    <div id="help-contents" style="display: none;">
      <div id="help-close">X</div>
      <img src="static/img/schema_hot.png" width="296" class="right" />
      <p>You can share a document from desktop computer to your mobile in seconds</p>
      <p>
        <ol>
          <li>Select a file from your computer on page <b>hotmaze.io</b></li>
          <li>Scan the QR-code with your mobile</li>
        </ol>
      </p>
      <p>That's it. No login, no passwords, no ads.</p>
      <p>Your mobile device must have a QR-code reader (get one <a href="https://play.google.com/store/search?q=QR%20reader" target="_blank">for Android</a>, or <a href="https://itunes.apple.com/app/qr-code-reader-and-scanner/id388175979?mt=8" target="_blank">for iOS</a>).</p>
      <p>The two devices (source and target) must have internet connection.</p>
      <p><strong>Your data remains private</strong>. It is not publicly available and not disclosed to third parties. See the <a href="terms.html">Privacy terms</a>.</p>

      <div class="link-to-dual">
      But I want to send from mobile to desktop instead! Use <a href="https://coolmaze.io/">Cool Maze</a>.
      </div>
    </div>
  </div>

  <div id="progress-zone">
    <progress value="0" id="upload-progress" style="display: none;"></progress>
  </div>

  <div id="form-zone" style="display: none;">
    <div id="resource-upload"> 
      <form> 
        <div id="drop-invite" style="display: none;">DROP FILE HERE</div>
        <input type="file" name="resource" id="resource" />
      </form>
    </div>
  </div>

  <div id="spin-zone">
    <img id="spin-img" src="static/img/red_spinner.gif" style="display: none;"/>
  </div>

  <div id="qr-zone">
    <div id="qrcode"> 
    </div>
  </div>

  <div id="errors">
  </div>







  <script type="text/javascript">
    // Those are a few hundred lines of highly questionable JS.
    // They should be rewritten entirely, but preferably keeping vanilla
    // JS, avoiding jQuery (25KB compressed) or other framework.

    var backend = "https://cool-maze.appspot.com";
    // var backend = "https://dev-dot-cool-maze.appspot.com";
    //var backend = "http://localhost:8080";

    var urlPut, urlGet;
    var resourceFile;
    var qrText = "";

    var errorZone = document.getElementById("errors");
    var progress = document.getElementById("upload-progress");
    var formZone = document.getElementById("form-zone")
    var qrcode = document.getElementById("qrcode");
    var qrzone = document.getElementById("qr-zone");
    var help = document.getElementById("help");
    var helpContents = document.getElementById("help-contents");
    var questionMark = document.getElementById("question-mark");
    var help = document.getElementById("help");
    var helpClose = document.getElementById("help-close");
    var helpContents = document.getElementById("help-contents");
    var spinner = document.getElementById("spin-img");
    var resourceInput = document.getElementById('resource');
    var dropInvite = document.getElementById("drop-invite");

    function showError(errmsg) {
      console.log("Error: " + errmsg)
      clearQR();
      freezeResize();
      errorZone.innerHTML = errmsg;
      return false;
    }

    var qrHundredth = 40;

    function render(colorDark, clickCallback){
      // qrHundredth == 95 is a "big QR-code" (almost fullscreen)
      // qrHundredth == 50 is a "medium-size QR-code"

      // -50 is for the small [?] box on the left
      var w = Math.max(document.documentElement.clientWidth -50, (window.innerWidth || 0) -50) * qrHundredth / 100;
      var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) * qrHundredth / 100;
      var c = 400;
      if ( w>0 )
        c = w;
      if ( h>0 && h<c )
        c = h;

      clearQR();
      new QRCode("qrcode", {
        text: qrText,
        width: c,
        height: c,
        colorDark : colorDark,
        colorLight : "white",
        correctLevel : QRCode.CorrectLevel.M
      });

      // The QR-code contents is clickable to embiggen, not the whole qr-zone
      if (clickCallback)
        for(var i=0; i < qrcode.childNodes.length; i++)
          qrcode.childNodes[i].onclick = clickCallback;
    }

    // Go fullscreen -> bigger QR
    var resizeTimeOut = null;
    window.onresize = function(){
        if (resizeTimeOut != null)
            clearTimeout(resizeTimeOut);
        resizeTimeOut = setTimeout(function(){
            render("black", embiggen);
        }, 300);
    };
    function freezeResize(){
      // after scan, or on fatal error, we don't need/want to
      // redisplay a fresh black QR-code again.
      window.onresize = function(){ return false; }
    }

    function clearQR() {
      var node = qrcode;
      while (node.firstChild) {
          node.removeChild(node.firstChild);
      }
    }

    function show(id) {
      switch(id) {
        case "qr-zone":
          helpContents.style.display = "none";
          break;
          case "help-contents":
          helpContents.style.display = "block";
          break;
      }
    }

    //document.body.onclick = function() { alert("BG"); show("qr-zone"); }
    questionMark.onclick = function(event) { 
        if ( helpContents.style.display === "none" )
          show("help-contents"); 
    }
    helpClose.onclick = function(event) { 
        show("qr-zone"); 
    }
    document.onkeydown = function(evt) {
      evt = evt || window.event;
      var isEscape = false;
      if ("key" in evt) {
        isEscape = (evt.key == "Escape" || evt.key == "Esc");
      } else {
        isEscape = (evt.keyCode == 27);
      }
      if (isEscape) {
        show("qr-zone");
      }
    };

    function embiggen(event) { 
        // Change size on each click
        // 40, 68, 96, 40, 60, 96 ...
        qrHundredth += 28;
        if ( qrHundredth>100 )
          qrHundredth = 40;
        render("black", embiggen);
    }

    function spin() {
      spinner.style.display = "inline";
    }

    function unspin() {
      spinner.style.display = "none";
    }

    function wakeUpBackend(){
      // This request can be slow.
      // We don't need to wait for the response.
      var wakeup = new XMLHttpRequest();
      var wuEndpoint = backend + "/wakeup";
      wakeup.open("GET", wuEndpoint, true);
      wakeup.send( null );
    }

    function requestGcsUrls(action){
      var r = new XMLHttpRequest();
      r.onreadystatechange = function() {
          if (r.readyState == 4 ) {
            if (r.status == 200) {
              var jsonResponse = JSON.parse(r.responseText);
              urlPut = jsonResponse.urlPut;
              console.log( "urlPut = " + urlPut );
              urlGet = jsonResponse.urlGet;
              console.log( "urlGet = " + urlGet );
              if( jsonResponse.shortUrlGet ){
                urlGet = backend + jsonResponse.shortUrlGet;
                console.log( "urlGet (short) = " + urlGet );
              }
              progress.style.display = "inline";
              action();
            } else if (r.status == 412) {
              var jsonResponse = JSON.parse(r.responseText);
              showError(jsonResponse.message);
            } else {
              showError("GCS urls request failed with " + r.status + ": " + r.responseText);
            }
          }
      };
      var endpoint = backend + "/new-gcs-urls";
      var params = "type=" + encodeURIComponent(resourceFile.type)
                   + "&filesize=" + resourceFile.size
                   + "&shorten=1"
                   + "&filename=" + encodeURIComponent(resourceFile.name) ;
      // TODO hash
      r.open("POST", endpoint + "?" + params, true);
      r.send( null );
    }

    window.addEventListener('offline', function(){
      showError("Lost internet connectivity :(")
    });


    function checkInternetAndExecute(action){
      // This request is supposed to be fast.
      var tinyRequest = new XMLHttpRequest();
      tinyRequest.onreadystatechange = function() {
          if (tinyRequest.readyState == 4 ) {
            if (tinyRequest.status == 200) {
              // Response ensures we have internet connectivity
              action();
            } else {
              showError("No internet...?");
            }
          }
      };
      tinyRequest.open("GET", backend+"/online", true);
      tinyRequest.send( null );
    }

    // Handle slight differences in Embed mode (iframe)
    function handleEmbedMode() {
      var inFrame = false;
      try {
          inFrame = (window.self !== window.top);
      } catch (e) {
          inFrame = true;
      }
      if ( inFrame ) {
        if ( help )
          help.style.display = "none";
      }
    }

    function doUpload(action) {          
      var up = new XMLHttpRequest();
      progress.value = 0.0;
      
      up.onreadystatechange = function(){
        if (up.readyState == 4 ) {
          if (up.status == 200) {
            progress.value = 1.0;
            console.log( up.responseText );
            action();
          }
        }
      };

      (up.upload || up).addEventListener('progress', function(e) {
          var done = e.position || e.loaded;
          var total = e.totalSize || e.total;
          var ratio = done/total;
          // console.log('Upload progress: ' + Math.round(ratio*100) + '%');
          progress.value = ratio;
      });
      
      up.open("PUT", urlPut);
      up.setRequestHeader("Content-Type", resourceFile.type);
      up.setRequestHeader("Content-Disposition", "filename=\"" + encodeURIComponent(resourceFile.name) + "\"");
      up.send(resourceFile);
    }

    function displayGetQrCode() {
      // We generate th QR-code of a custom "medium-size" shortURL,
      // much shorter than the full signed GCS download URL.
      qrText = urlGet;
      render("black", embiggen);

      // GCS URL will be valid for a few minutes only.
      // Discard QR-code after 9mn.
      window.setTimeout(function(){ 
        if ( qrzone.style.display == "block" || qrzone.style.display == "" ) {
          showError("Please reload.");
        }
      }, 9 * 60 * 1000);
    }

    function processResourceFile() {
       // Here, resourceFile has been set either through the file select input,
       // or through a drag'n'drop.
       // What happens next with resourceFile is the same in both use cases.

      requestGcsUrls(function(){
        doUpload(function(){
          unspin();
          displayGetQrCode();
        });
      });
    }

    resourceInput.onchange = function(e) { 
        formZone.style.display = "none";
        spin();
        resourceFile = resourceInput.files[0];
        processResourceFile();
    };

    function handleDnd(){
      // See https://css-tricks.com/drag-and-drop-file-uploading/
      var div = document.createElement('div');
      var dndFileSupported = (('draggable' in div) 
        || ('ondragstart' in div && 'ondrop' in div)) 
        && 'FormData' in window && 'FileReader' in window;
      if (!dndFileSupported)
        return;

      dropInvite.style.display = "block";

      var dropZone = document.body;

      function highlightDropZone(){
        dropZone.style.border = 'red dotted 10px';
      }

      function unhighlightDropZone(){
        dropZone.style.border = 'rgba(255, 255, 255, 0) solid 10px';
      }

      dropZone.addEventListener('dragover', function(evt){
        evt.stopPropagation();
        evt.preventDefault();
        highlightDropZone()
        evt.dataTransfer.dropEffect = 'copy';
      }, false);

      dropZone.addEventListener('drop', function(evt){
        evt.stopPropagation();
        evt.preventDefault();
        show("qr-zone");
        unhighlightDropZone();

        formZone.style.display = "none";

        var files = evt.dataTransfer.files;
        if( files.length>1 ){
          showError("Multiple upload not supported (yet)");
          return;
        }

        spin();
        // Upload 1st file.
        resourceFile = files[0];
        processResourceFile();
        // TODO upload all files ..?
      }, false);

      dropZone.addEventListener('dragleave', function(evt){
        unhighlightDropZone();
      }, false);
    }
    handleDnd();

    checkInternetAndExecute(function(){
      // #135: Unlock upload widgets, only if we do have internet!
      formZone.style.display = "block";
    });
    wakeUpBackend();
    handleEmbedMode();
  </script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-40444778-5', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
