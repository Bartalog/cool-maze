<!DOCTYPE html>
<html>
<head>
  <!-- <title>Cool Maze - Send your document from mobile to computer</title> -->
  <title>Cool Maze - Share your URL from mobile to computer</title>
  <script src="https://js.pusher.com/3.0/pusher.min.js"></script>
  <script src="static/js/qrcodejs/qrcode.min.js"></script>
  <link rel="SHORTCUT ICON" href="static/img/coolmaze_128.png" />
  <style>
  body {
    text-align: center;
  }
  input[readonly]
  {
    background-color: white;
  }

  #qrcode {
    text-align: center;
  }
  #qrcode img {
    margin: auto;
  }
  #overprint-logo {
    position: absolute;
  }
  #chanid-hint {
    border: none;
    float: right;
    color: #ccc;
  }
  #inbox {
    margin-top: 12px;
    border: none;
  }
  </style>
</head>
<body>
  <input type="text" readonly="readonly" id="chanid-hint" size="5">
  <div>
    <div id="qrcode"> 
      <img src="static/img/red_arrow.png" id="overprint-logo" />
    </div>
  </div>
  <textarea id="inbox" readonly="readonly" rows="3" cols="50"></textarea>

  <script type="text/javascript">

    // Get a good random value
    var r1 = new Uint32Array(1);
    window.crypto.getRandomValues(r1);
    var r = r1[0] % 100000;
    var chanID = '' + r;
    // TODO if getRandomValues capability not present, then get a number from a server somewhere.

    var pusher = new Pusher('e36002cfca53e4619c15', {
      encrypted: true
    });
    var channel = pusher.subscribe(chanID);
    var event = 'maze-cast';
    channel.bind(event, function(data) {
      var msg = data.message;
      if(startsWith(msg,'http') || startsWith(msg,'www.')) {
         var url = msg;
         window.location = url;
      }else{
         //alert(data.message);
         console.log("Received message: " + data.message);
         document.getElementById("inbox").value = data.message;
      }
    });

    function render(){
      var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0) * 8 / 10;
      var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) * 8 / 10;
      var c = 400;
      if ( w>0 )
        c = w;
      if ( h>0 && h<c )
        c = h;

      clearQR();
      new QRCode("qrcode", {
        text: chanID,
        width: c,
        height: c
      });

      document.getElementById("chanid-hint").value = chanID;

      var cc = c/4;
      document.getElementById("overprint-logo").style.width = cc + "px";
      document.getElementById("overprint-logo").style.height = cc + "px";
      document.getElementById("overprint-logo").style.top = ((1.5)*cc) + "px";
      document.getElementById("overprint-logo").style.marginLeft = (-cc/2) + "px";
    }

    render();

    // Go fullscreen -> bigger QR
    var resizeTimeOut = null;
    window.onresize = function(){
        if (resizeTimeOut != null)
            clearTimeout(resizeTimeOut);
        resizeTimeOut = setTimeout(function(){
            render();
        }, 300);
    };

    function clearQR() {
      var node = document.getElementById("qrcode");
      while (node.firstChild) {
          node.removeChild(node.firstChild);
      }
      node.innerHTML='<img src="static/img/red_arrow.png" id="overprint-logo" />';
    }

    function startsWith(str, word) {
     return str.lastIndexOf(word, 0) === 0;
    }

    var wakeup = new XMLHttpRequest();
    wakeup.open("GET", "https://cool-maze.appspot.com/wakeup", true);
    wakeup.send(null);
  </script>
</body>
</html>